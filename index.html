<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Energia Incidente</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 min-h-screen text-white p-4">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-6">Calculadora de Energia Incidente (IEEE 1584-2018)</h1>

    <!-- Escala visual -->
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-2">Escala de Risco (cal/cm²)</h2>
      <div class="relative h-8 w-full bg-gradient-to-r from-green-500 via-yellow-400 to-red-600 rounded overflow-hidden">
        <div id="marcador" class="absolute top-0 left-0 w-1 h-8 bg-white"></div>
      </div>
      <div class="flex justify-between text-sm text-white/80 mt-1">
        <span>0</span>
        <span>1.2</span>
        <span>4</span>
        <span>8</span>
        <span>25</span>
        <span>40+</span>
      </div>
    </div>

    <div class="grid gap-6 md:grid-cols-2">
      <!-- Inputs -->
      <div class="space-y-4">
        <label class="block">Tensão (V)
          <input type="number" id="tensao" placeholder="Ex: 480, 4160, 13800" class="w-full p-2 rounded bg-white/10 border border-white/20 placeholder-white/60"/>
        </label>
        <label class="block">Corrente de Curto (A)
          <input type="number" id="corrente" placeholder="Ex: 10000, 25000" class="w-full p-2 rounded bg-white/10 border border-white/20 placeholder-white/60"/>
        </label>
        <label class="block">Tempo de Arco (s)
          <input type="number" step="0.01" id="tempo" placeholder="Ex: 0.2, 0.5, 1.0" class="w-full p-2 rounded bg-white/10 border border-white/20 placeholder-white/60"/>
        </label>
        <label class="block">Distância (mm)
          <input type="number" id="distancia" placeholder="Ex: 610, 910, 1220" class="w-full p-2 rounded bg-white/10 border border-white/20 placeholder-white/60"/>
        </label>
        <label class="block">Gap entre Condutores (mm)
          <input type="number" id="gap" placeholder="Ex: 25, 32, 76" class="w-full p-2 rounded bg-white/10 border border-white/20 placeholder-white/60"/>
        </label>
        <label class="block">Configuração
          <select id="configuracao" class="w-full p-2 rounded bg-white/10 border border-white/20 text-white">
            <option value="vcb" class="text-black">VCB (Vertical in Box)</option>
            <option value="hcb" class="text-black">HCB (Horizontal in Box)</option>
            <option value="voa" class="text-black">VOA (Vertical Open Air)</option>
            <option value="hoa" class="text-black">HOA (Horizontal Open Air)</option>
          </select>
        </label>
        <button onclick="calcular()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold p-2 rounded">Calcular (IEEE)</button>
        <button onclick="calcularRalphLee()" class="w-full bg-orange-400 hover:bg-orange-500 text-black font-bold p-2 rounded">Calcular (Ralph Lee)</button>
        <button onclick="exportarPDF()" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-black font-bold p-2 rounded">Exportar PDF (com Memorial)</button>
      </div>

      <!-- Resultados -->
      <div id="resultado" class="bg-white/10 p-4 rounded border border-white/20">
        <h2 class="text-2xl font-bold mb-4">Resultado</h2>
        <div id="output" class="space-y-2 text-white"></div>

        <h3 class="text-xl mt-6 font-bold">EPI Recomendado</h3>
        <ul id="epis" class="text-sm text-white/80 list-disc pl-4 mt-2"></ul>

        <h3 class="text-xl mt-6 font-bold">Histórico</h3>
        <ul id="historico" class="text-sm text-white/80 list-disc pl-4 mt-2"></ul>
      </div>
    </div>
<script>
  function calcular() {
    const V = parseFloat(document.getElementById("tensao").value);
    const I = parseFloat(document.getElementById("corrente").value);
    const t = parseFloat(document.getElementById("tempo").value);
    const D = parseFloat(document.getElementById("distancia").value);
    const G = parseFloat(document.getElementById("gap").value);
    const config = document.getElementById("configuracao").value;

    if (!V || !I || !t || !D || !G) {
      alert("Preencha todos os campos com valores válidos.");
      return;
    }

    const Vkv = V / 1000;
    const Ika = I / 1000;
    const Dm = D / 1000;

    const coef = {
      vcb: { k1: 0.973, k2: 1.0, x: 0.662, y: 0.954, z: 2.0 },
      hcb: { k1: 1.000, k2: 1.0, x: 0.662, y: 0.954, z: 2.0 },
      voa: { k1: 1.081, k2: 1.0, x: 0.662, y: 0.954, z: 2.0 },
      hoa: { k1: 1.116, k2: 1.0, x: 0.662, y: 0.954, z: 2.0 }
    };

    const { k1, k2, x, y, z } = coef[config];
    const Cf = 1.0;

    const logIarc = -0.153 + 0.662 * Math.log10(Ika) + 0.0966 * Vkv + 0.000526 * G + 0.5588 * Vkv * Math.log10(Ika) - 0.00304 * G * Math.log10(Ika);
    const Iarc = Math.pow(10, logIarc);
    const E = 4.184 * Cf * k1 * k2 * Math.pow(Iarc, x) * Math.pow(t, y) * Math.pow(Dm, -z);

    mostrarResultado(E, Iarc, "IEEE 1584-2018", V, I, t, D, config);
  }

  function calcularRalphLee() {
    const I = parseFloat(document.getElementById("corrente").value);
    const t = parseFloat(document.getElementById("tempo").value);
    const D = parseFloat(document.getElementById("distancia").value);

    if (!I || !t || !D) {
      alert("Preencha corrente, tempo e distância.");
      return;
    }

    const E = 0.01 * I * t / Math.pow(D, 1.473);
    mostrarResultado(E, I, "Ralph Lee (1987)", null, I, t, D, null);
  }

  function mostrarResultado(E, Iarc, metodo, V, I, t, D, config) {
    let categoria = "";
    if (E < 1.2) categoria = "Categoria 0";
    else if (E < 4) categoria = "Categoria 1";
    else if (E < 8) categoria = "Categoria 2";
    else if (E < 25) categoria = "Categoria 3";
    else if (E < 40) categoria = "Categoria 4";
    else categoria = "PERIGO EXTREMO";

    // Atualiza marcador visual
    const escala = document.querySelector(".w-full.bg-gradient-to-r");
    const largura = escala.clientWidth;
    let pos = Math.min(E / 45, 1) * largura;
    document.getElementById("marcador").style.left = pos + "px";

    // Exibe resultado
    document.getElementById("output").innerHTML = `
      <p><strong>Método:</strong> ${metodo}</p>
      <p><strong>Energia Incidente:</strong> ${E.toFixed(2)} cal/cm²</p>
      <p><strong>Corrente de Arco:</strong> ${Iarc.toFixed(2)} ${metodo.includes("Ralph") ? "A" : "kA"}</p>
      <p><strong>Categoria de EPI:</strong> ${categoria}</p>
    `;

    // EPIs recomendados
    const epis = {
      "Categoria 0": ["Roupas normais de trabalho", "Óculos de segurança"],
      "Categoria 1": ["Camisa/calça FR", "Óculos de proteção", "Luvas isolantes"],
      "Categoria 2": ["Camisa/calça FR", "Protetor facial com AR", "Luvas"],
      "Categoria 3": ["Conjunto FR completo", "Protetor facial + AR", "Capuz balaclava", "Luvas"],
      "Categoria 4": ["FR multicamadas", "Capacete AR", "Protetor facial", "Luvas"],
      "PERIGO EXTREMO": ["Desenergizar o equipamento antes de intervir"]
    };

    document.getElementById("epis").innerHTML =
      epis[categoria].map(e => `<li>${e}</li>`).join("");

    salvarHistorico({ V, I, t, D, E: E.toFixed(2), categoria, metodo });
  }

  function salvarHistorico(item) {
    const historico = JSON.parse(localStorage.getItem("historicoEPI")) || [];
    historico.unshift(item);
    localStorage.setItem("historicoEPI", JSON.stringify(historico.slice(0, 5)));
    mostrarHistorico();
  }

  function mostrarHistorico() {
    const historico = JSON.parse(localStorage.getItem("historicoEPI")) || [];
    const lista = historico.map(h =>
      `<li>${h.metodo}: ${h.E} cal/cm² (${h.categoria})</li>`
    ).join("");
    document.getElementById("historico").innerHTML = lista;
  }

  function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("Memorial de Cálculo - Energia Incidente", 20, 20);
    doc.setFontSize(12);

    const tensao = document.getElementById("tensao").value;
    const corrente = document.getElementById("corrente").value;
    const tempo = document.getElementById("tempo").value;
    const distancia = document.getElementById("distancia").value;
    const gap = document.getElementById("gap").value;
    const config = document.getElementById("configuracao").selectedOptions[0].text;

    const outputText = document.getElementById("output").innerText;

    const texto = `
Dados de Entrada:
- Tensão: ${tensao} V
- Corrente: ${corrente} A
- Tempo de arco: ${tempo} s
- Distância: ${distancia} mm
- Gap: ${gap} mm
- Configuração: ${config}

Resultado:
${outputText}
`;

    const linhas = doc.splitTextToSize(texto, 170);
    doc.text(linhas, 20, 40);
    doc.save("memorial_energia_incidente.pdf");
  }

  mostrarHistorico();
</script>
</body>
</html>

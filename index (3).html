<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Energia Incidente</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 min-h-screen text-white p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-6">Calculadora de Energia Incidente (IEEE 1584-2018)</h1>

    <div class="grid gap-6 md:grid-cols-2">
      <div class="space-y-4">
        <label class="block">Tensão (V)
          <input type="number" id="tensao" class="w-full p-2 rounded bg-white/10 border border-white/20"/>
        </label>
        <label class="block">Corrente de Curto (A)
          <input type="number" id="corrente" class="w-full p-2 rounded bg-white/10 border border-white/20"/>
        </label>
        <label class="block">Tempo de Arco (s)
          <input type="number" step="0.01" id="tempo" class="w-full p-2 rounded bg-white/10 border border-white/20"/>
        </label>
        <label class="block">Distância (mm)
          <input type="number" id="distancia" class="w-full p-2 rounded bg-white/10 border border-white/20"/>
        </label>
        <label class="block">Gap entre Condutores (mm)
          <input type="number" id="gap" class="w-full p-2 rounded bg-white/10 border border-white/20"/>
        </label>
        <label class="block">Configuração
          <select id="configuracao" class="w-full p-2 rounded bg-white/10 border border-white/20">
            <option value="vcb">VCB (Vertical in Box)</option>
            <option value="hcb">HCB (Horizontal in Box)</option>
            <option value="voa">VOA (Vertical Open Air)</option>
            <option value="hoa">HOA (Horizontal Open Air)</option>
          </select>
        </label>
        <button onclick="calcular()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold p-2 rounded">Calcular</button>
        <button onclick="exportarPDF()" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-black font-bold p-2 rounded">Exportar PDF</button>
      </div>

      <div id="resultado" class="bg-white/10 p-4 rounded border border-white/20">
        <h2 class="text-2xl font-bold mb-4">Resultado</h2>
        <div id="output" class="space-y-2 text-white"></div>
        <h3 class="text-xl mt-4 font-bold">Histórico</h3>
        <ul id="historico" class="text-sm text-white/80 list-disc pl-4 mt-2"></ul>
      </div>
    </div>
  </div>

  <script>
    function calcular() {
      const V = parseFloat(document.getElementById("tensao").value);
      const I = parseFloat(document.getElementById("corrente").value);
      const t = parseFloat(document.getElementById("tempo").value);
      const D = parseFloat(document.getElementById("distancia").value);
      const G = parseFloat(document.getElementById("gap").value);
      const config = document.getElementById("configuracao").value;

      if (!V || !I || !t || !D || !G) {
        alert("Preencha todos os campos com valores válidos.");
        return;
      }

      const Vkv = V / 1000;
      const Ika = I / 1000;
      const Dm = D / 1000;

      const coef = {
        vcb: { k1: 0.973, k2: 1.0, x: 0.662, y: 0.954, z: 2.0 },
        hcb: { k1: 1.000, k2: 1.0, x: 0.662, y: 0.954, z: 2.0 },
        voa: { k1: 1.081, k2: 1.0, x: 0.662, y: 0.954, z: 2.0 },
        hoa: { k1: 1.116, k2: 1.0, x: 0.662, y: 0.954, z: 2.0 }
      };

      const { k1, k2, x, y, z } = coef[config];
      const Cf = 1.0;

      const logIarc = -0.153 + 0.662 * Math.log10(Ika) + 0.0966 * Vkv + 0.000526 * G + 0.5588 * Vkv * Math.log10(Ika) - 0.00304 * G * Math.log10(Ika);
      const Iarc = Math.pow(10, logIarc);
      const E = 4.184 * Cf * k1 * k2 * Math.pow(Iarc, x) * Math.pow(t, y) * Math.pow(Dm, -z);

      let categoria = "";
      if (E < 1.2) categoria = "Categoria 0";
      else if (E < 4) categoria = "Categoria 1";
      else if (E < 8) categoria = "Categoria 2";
      else if (E < 25) categoria = "Categoria 3";
      else if (E < 40) categoria = "Categoria 4";
      else categoria = "PERIGO EXTREMO";

      const resultadoHTML = `
        <p><strong>Energia Incidente:</strong> ${E.toFixed(2)} cal/cm²</p>
        <p><strong>Corrente de Arco:</strong> ${Iarc.toFixed(2)} kA</p>
        <p><strong>Categoria de EPI:</strong> ${categoria}</p>
      `;
      document.getElementById("output").innerHTML = resultadoHTML;

      salvarHistorico({ V, I, t, D, G, config, E: E.toFixed(2), categoria });
    }

    function salvarHistorico(item) {
      const historico = JSON.parse(localStorage.getItem("historicoEPI")) || [];
      historico.unshift(item);
      localStorage.setItem("historicoEPI", JSON.stringify(historico.slice(0, 5)));
      mostrarHistorico();
    }

    function mostrarHistorico() {
      const historico = JSON.parse(localStorage.getItem("historicoEPI")) || [];
      const lista = historico.map(h => 
        `<li>${h.V}V, ${h.I}A, ${h.t}s, ${h.D}mm → ${h.E} cal/cm² (${h.categoria})</li>`
      ).join("");
      document.getElementById("historico").innerHTML = lista;
    }

    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Relatório de Energia Incidente", 20, 20);
      const content = document.getElementById("output").innerText;
      doc.setFontSize(12);
      doc.text(content, 20, 40);
      doc.save("relatorio_energia_incidente.pdf");
    }

    mostrarHistorico();
  </script>
</body>
</html>
